# =============================================================================
# Contributor Validation Workflow
# =============================================================================
# Ensures that all pull requests and direct pushes originate from approved
# team members. Blocks unauthorized contributions at the CI level before
# code review begins.
#
# Contributor list is maintained in this file under the ALLOWED_CONTRIBUTORS
# environment variable. Update it when team membership changes.
# =============================================================================

name: Validate Contributor

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]
  push:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

env:
  # -------------------------------------------------------------------------
  # APPROVED CONTRIBUTORS
  # -------------------------------------------------------------------------
  # GitHub usernames of all authorized team members.
  # Add or remove usernames as needed. One username per line for readability.
  # -------------------------------------------------------------------------
  ALLOWED_CONTRIBUTORS: |
    ashutosh-ranjan2611
    NehaBondade
    surjannu
    ottp613

jobs:
  validate-contributor:
    name: Check Contributor Authorization
    runs-on: ubuntu-latest

    steps:
      - name: Identify actor
        id: identity
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            ACTOR="${{ github.event.pull_request.user.login }}"
            EVENT_TYPE="pull_request"
            REF="${{ github.event.pull_request.number }}"
          else
            ACTOR="${{ github.actor }}"
            EVENT_TYPE="push"
            REF="${{ github.ref_name }}"
          fi

          echo "actor=${ACTOR}" >> "$GITHUB_OUTPUT"
          echo "event_type=${EVENT_TYPE}" >> "$GITHUB_OUTPUT"
          echo "ref=${REF}" >> "$GITHUB_OUTPUT"
          echo "--- Detected actor: ${ACTOR} (${EVENT_TYPE} on ${REF}) ---"

      - name: Validate against contributor list
        id: validate
        run: |
          ACTOR="${{ steps.identity.outputs.actor }}"

          # Parse the allowed contributors list (one per line, trim whitespace)
          MATCH="false"
          while IFS= read -r username; do
            username=$(echo "${username}" | xargs)  # trim whitespace
            [ -z "${username}" ] && continue         # skip blank lines
            if [ "${username}" = "${ACTOR}" ]; then
              MATCH="true"
              break
            fi
          done <<< "${{ env.ALLOWED_CONTRIBUTORS }}"

          echo "authorized=${MATCH}" >> "$GITHUB_OUTPUT"

          if [ "${MATCH}" = "true" ]; then
            echo "--- AUTHORIZED: ${ACTOR} is an approved contributor ---"
          else
            echo "--- UNAUTHORIZED: ${ACTOR} is not in the contributor list ---"
          fi

      - name: Block unauthorized contributor
        if: steps.validate.outputs.authorized == 'false'
        run: |
          ACTOR="${{ steps.identity.outputs.actor }}"
          EVENT="${{ steps.identity.outputs.event_type }}"
          REF="${{ steps.identity.outputs.ref }}"

          echo "============================================================"
          echo "  CONTRIBUTION BLOCKED"
          echo "============================================================"
          echo ""
          echo "  Actor:    ${ACTOR}"
          echo "  Event:    ${EVENT} on ${REF}"
          echo "  Reason:   Not in approved contributor list"
          echo ""
          echo "  If you believe this is an error, contact a repository"
          echo "  administrator to add your GitHub username to the"
          echo "  contributor list in .github/workflows/validate-contributor.yml"
          echo ""
          echo "============================================================"
          exit 1

      - name: Comment on unauthorized PR
        if: |
          steps.validate.outputs.authorized == 'false' &&
          steps.identity.outputs.event_type == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const actor = '${{ steps.identity.outputs.actor }}';
            const prNumber = context.payload.pull_request.number;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: [
                `**Contributor Validation Failed**\n`,
                `The author of this pull request (\`${actor}\`) is not in the approved contributor list for this repository.\n`,
                `If you are a team member, please ask a repository administrator to add your GitHub username to the contributor list in \`.github/workflows/validate-contributor.yml\`.\n`,
                `This check must pass before the PR can be reviewed or merged.`
              ].join('\n')
            });

      - name: Confirm authorized contributor
        if: steps.validate.outputs.authorized == 'true'
        run: |
          ACTOR="${{ steps.identity.outputs.actor }}"
          echo "--- ${ACTOR} is authorized. Proceeding. ---"